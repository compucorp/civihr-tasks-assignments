define(['services/services',        'services/utils'], function (services) {    services.factory('Task',['$resource', 'settings', '$log', function($resource, settings, $log){        $log.debug('Service: Task');        return $resource(settings.pathRest,{            'action': 'getbycomponent',            'entity': 'Task',            'json': {}        });    }]);    services.factory('TaskService',['Task', '$q', 'settings', 'UtilsService', '$log',        function(Task, $q, settings, UtilsService, $log){        $log.debug('Service: TaskService');        return {            get: function(params){                var deferred = $q.defer();                params = params && typeof params === 'object' ? params : {};                params = angular.extend({                    'component': 'CiviTask',                    'sequential': '1',                    'target_contact_id': settings.contactId,                    'return': 'activity_date_time, activity_type_id, assignee_contact_id, details, id, source_contact_id, target_contact_id'                },params);                Task.get({json: params}, function(data){                    deferred.resolve(data.values);                },function(){                    deferred.reject('Unable to fetch tasks list');                });                return deferred.promise;            },            getOptions: function(){                var deferred = $q.defer(), i = 0, len,                    options = {                        taskType: {                            arr: [],                            obj: {}                        },                        status: {}                    }                Task.get({                    action: 'getoptions',                    json: {                        'field': 'activity_type_id'                    }                }, function(data){                    var optionId;                    for (optionId in data.values) {                        options.taskType.arr.push({                            key: optionId,                            value: data.values[optionId]                        })                    }                    options.taskType.obj = data.values;                    deferred.resolve(options);                });                return deferred.promise;            },            save: function(task){                if (!task || typeof task !== 'object') {                    return null;                }                var deferred = $q.defer(),                    params = angular.extend({                        sequential: 1,                        debug: settings.debug                    },task),                    val;                Task.save({                    action: 'create',                    json: params                }, null, function(data){                    if (UtilsService.errorHandler(data,'Unable to save task',deferred)) {                        return                    }                    val = data.values;                    deferred.resolve(val.length == 1 ? val[0] : null);                },function(){                    deferred.reject('Unable to save task');                });                return deferred.promise;            },            delete: function(taskId) {                if (!taskId || typeof +taskId !== 'number') {                    return null;                }                var deferred = $q.defer();                Task.delete({                    action: 'delete',                    json: { id: taskId }                }, function(data){                    deferred.resolve(data);                },function(){                    deferred.reject('Could not delete task ID: '+taskId);                });                return deferred.promise;            }        }    }]);});